# Заставить «OOM killer'а» игнорировать процесс

Отключение OOM killer выполняется по процессам, поэтому вам нужно знать PID запущенного процесса, который вы хотите защитить. Это далеко от идеала, поскольку идентификаторы процессов могут часто меняться, но мы можем создавать сценарии вокруг этого.

Как задокументировано http://linux-mm.org/OOM_Killer: "Любой конкретный руководитель процесса может быть иммунизирован против oom killer, если значение его **/proc/$pid/oom_adj** установлено в константу OOM_DISABLE (в настоящее время определяется как -17) ."

Это означает, что мы можем отключить OOM killer для отдельного процесса, если мы знаем его PID, используя следующую команду:

```console
# OOM_DISABLE on $PID
echo -17 > /proc/$PID/oom_adj
```

Используя **pgrep**, мы можем запустить это, зная только имя процесса. Например, давайте удостоверимся, что слушатель **ssh** не убил OOM:

```console
pgrep -f "/usr/sbin/sshd" | while read PID; do echo -17 > /proc/$PID/oom_adj; done
```

Здесь мы использовали **pgrep** для поиска полного соответствия командной строки **(-f) /usr/sbin/sshd**, а затем вставили -17 в запись **procfs** для каждого соответствующего pid.

Чтобы автоматизировать это, вы можете регулярно запускать cron для обновления записи **oom_adj**. Это простой способ убедиться, что **sshd** исключен из OOM killer после перезапуска демона или сервера.

```cron
#/etc/cron.d/oom_disable
*/1 * * * * root pgrep -f "/usr/sbin/sshd" | while read PID; do echo -17 > /proc/$PID/oom_adj; done
```

Вышеуказанное задание будет выполняться каждую минуту, обновляя **oom_adj** текущего процесса, соответствующего **/usr/sbin/sshd**. Конечно, это может быть расширено, чтобы включить любые другие процессы, которые вы хотите исключить из OOM killer.

Я рекомендую отключить OOM killer на уровне отдельных процессов, а не отключать его для всей системы. Если вообще отключить OOM killer, ваша система будет испытывать панику ядра под сильным давлением памяти. Исключая критические административные процессы, вы должны, по крайней мере, иметь возможность войти в систему для устранения проблем с высоким использованием памяти.


**********
[OOM killer](/tags/OOM%20killer.md)
